<script>
    const API_URL = "https://laravel-backend-latest.onrender.com/api";

    const fetchAndDisplayUsers = async () => {
        const token = localStorage.getItem('access_token');
        if (!token) return console.error('No access token found in local storage');

        try {
            const response = await axios.get(`${API_URL}/users`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            const users = response.data;
            const usersContainer = document.getElementById('users-container');
            usersContainer.innerHTML = '';

            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'user';

                let roleDisplay;
                if (user.role === 'admin') roleDisplay = 'Beheerder';
                else if (user.role === 'member') roleDisplay = 'Lid';
                else roleDisplay = 'Er is iets fout gegaan!';

                userDiv.innerHTML = `
                    <div class='gebruikersdiv'>
                        <h4>Naam: ${user.name}</h4>
                        <h4>Email: ${user.email}</h4>
                        <h4>Rol: ${roleDisplay}</h4>
                        <button onclick="showUpdateUserForm(${user.id}, '${user.name}', '${user.email}')">Bijwerken</button>
                        <button onclick="deleteUser(${user.id})">Verwijderen</button>
                    </div>
                `;
                usersContainer.appendChild(userDiv);
            });
        } catch (error) {
            console.error('Error fetching users:', error);
        }
    };

    const addUser = async () => {
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const passwordConfirmation = document.getElementById('password_confirmation').value;
        const token = localStorage.getItem('access_token');
        if (!token) return console.error('No access token found in local storage');

        try {
            const response = await axios.post(`${API_URL}/register`, {
                name,
                email,
                password,
                password_confirmation: passwordConfirmation
            }, { headers: { 'Authorization': `Bearer ${token}` } });

            if (response.status === 200 || response.status === 201) {
                alert('Gebruiker succesvol toegevoegd');
                fetchAndDisplayUsers();
                hideAddUserForm();
            }
        } catch (error) {
            console.error('Error adding user:', error);
        }
    };

    const deleteUser = async (id) => {
        const token = localStorage.getItem('access_token');
        if (!token) return console.error('No access token found in local storage');

        const loggedInUserId = localStorage.getItem('user_id');
        if (id == loggedInUserId) return alert('Cannot delete yourself while logged in');

        try {
            const response = await axios.delete(`${API_URL}/users/${id}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.status === 200) {
                alert('Gebruiker succesvol verwijderd');
                fetchAndDisplayUsers();
            }
        } catch (error) {
            console.error('Error deleting user:', error);
        }
    };

    const updateUser = async () => {
        const id = document.getElementById('update-user-id').value;
        const name = document.getElementById('update-name').value;
        const email = document.getElementById('update-email').value;
        const token = localStorage.getItem('access_token');
        if (!token) return console.error('No access token found in local storage');

        try {
            const response = await axios.patch(`${API_URL}/users/${id}`, {
                name,
                email
            }, { headers: { 'Authorization': `Bearer ${token}` } });

            if (response.status === 200) {
                alert('Gebruiker succesvol bijgewerkt');
                fetchAndDisplayUsers();
                hideUpdateUserForm();
            }
        } catch (error) {
            console.error('Error updating user:', error);
        }
    };

    window.onload = fetchAndDisplayUsers;
</script>
